name: Scorecards Installation Workflow

on:
  workflow_call:
    inputs:
      scorecards-repo:
        description: 'Central scorecards repository (owner/repo)'
        required: false
        type: string
        default: 'feddericovonwernich/scorecards'
      scorecards-branch:
        description: 'Branch to commit results to in central repo'
        required: false
        type: string
        default: 'catalog'
    secrets:
      github-token:
        description: 'GitHub token for basic operations'
        required: true
      scorecards-catalog-token:
        description: 'Token for writing results to catalog branch (repo scope)'
        required: true
      scorecards-workflow-token:
        description: 'Token for creating PRs with workflow files (repo + workflow scopes)'
        required: false

jobs:
  check-status:
    name: Check Installation Status
    runs-on: ubuntu-latest
    outputs:
      installed: ${{ steps.check.outputs.installed }}
      pr-exists: ${{ steps.check-pr.outputs.exists }}
      pr-number: ${{ steps.check-pr.outputs.number }}
      pr-state: ${{ steps.check-pr.outputs.state }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if scorecards is installed
        id: check
        run: |
          if [ -f ".github/workflows/scorecards.yml" ]; then
            echo "installed=true" >> $GITHUB_OUTPUT
            echo "âœ… Scorecards workflow is installed"
          else
            echo "installed=false" >> $GITHUB_OUTPUT
            echo "âŒ Scorecards workflow not found"
          fi

      - name: Check for existing installation PR
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.github-token }}
        run: |
          # Search for PRs with the scorecards-install label (including closed ones)
          # By default, gh pr list sorts by creation date descending (newest first)
          pr_data=$(gh pr list --label "scorecards-install" --state all --json number,state,title --limit 1)

          if [ "$pr_data" = "[]" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "number=" >> $GITHUB_OUTPUT
            echo "state=" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No existing installation PR found"
          else
            pr_number=$(echo "$pr_data" | jq -r '.[0].number')
            pr_state=$(echo "$pr_data" | jq -r '.[0].state')
            pr_title=$(echo "$pr_data" | jq -r '.[0].title')

            echo "exists=true" >> $GITHUB_OUTPUT
            echo "number=$pr_number" >> $GITHUB_OUTPUT
            echo "state=$pr_state" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Found PR #$pr_number ($pr_state): $pr_title"
          fi

  create-installation-pr-placeholder:
    name: Create Installation PR (Placeholder)
    runs-on: ubuntu-latest
    needs: check-status
    if: needs.check-status.outputs.installed == 'false' && needs.check-status.outputs.pr-exists == 'false'
    outputs:
      pr-number: ${{ steps.create-pr.outputs.pr-number }}
      pr-state: ${{ steps.create-pr.outputs.pr-state }}
      pr-url: ${{ steps.create-pr.outputs.pr-url }}
    steps:
      - name: Checkout service repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.scorecards-workflow-token || secrets.github-token }}

      - name: Checkout scorecards repository for templates
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.scorecards-repo }}
          path: .scorecards-tmp
          ref: main

      - name: Create branch for installation
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b scorecards-install

      - name: Copy workflow template
        run: |
          mkdir -p .github/workflows

          # Copy template and customize it
          sed -e "s|feddericovonwernich/scorecards|${{ inputs.scorecards-repo }}|g" \
              -e "s|scorecards-branch: 'catalog'|scorecards-branch: '${{ inputs.scorecards-branch }}'|g" \
              .scorecards-tmp/documentation/examples/scorecard-workflow-template.yml > .github/workflows/scorecards.yml

          echo "âœ… Created .github/workflows/scorecards.yml"

      - name: Create config template
        run: |
          mkdir -p .scorecard

          # Extract repo name and org
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          ORG_NAME="${GITHUB_REPOSITORY%/*}"

          # Create config with basic info
          cat > .scorecard/config.yml << EOF
          service:
            name: "$REPO_NAME"
            team: ""
            description: ""
            links: []
          EOF

          echo "âœ… Created .scorecard/config.yml"

      - name: Commit changes
        run: |
          git add .github/workflows/scorecards.yml .scorecard/config.yml
          git commit -m "chore: Add Scorecards quality monitoring

          - Add scorecards workflow (runs daily)
          - Add scorecards config template

          Scorecard results will be updated after calculation."

      - name: Push branch
        run: |
          git push origin scorecards-install

      - name: Create Pull Request
        id: create-pr
        env:
          GH_TOKEN_RAW: ${{ secrets.scorecards-workflow-token || secrets.github-token }}
        run: |
          # Sanitize token by removing any trailing whitespace/newlines
          export GH_TOKEN=$(echo -n "$GH_TOKEN_RAW" | tr -d '\n\r\t ')

          # Create PR body (results will be added later)
          cat > pr-body.md << 'EOF'
          ## ðŸŽ¯ Scorecards Quality Monitoring

          This PR adds automated quality monitoring using Scorecards.

          ### What's Included

          - **Workflow file**: `.github/workflows/scorecards.yml` - Runs daily to calculate quality scores
          - **Config file**: `.scorecard/config.yml` - Service metadata and configuration

          ### Current Score

          â³ Calculating scores... Results will be updated shortly.

          ### What Happens After Merge

          Once merged, scorecards will:
          - âœ… Run daily via cron schedule (configurable)
          - âœ… Post results to the central catalog
          - âœ… Generate quality badges for your README
          - âœ… Track score trends over time

          ### Customize Your Config

          Edit `.scorecard/config.yml` to add:
          - Team name
          - Service description
          - Links to documentation
          - OpenAPI spec location (if applicable)

          ### Learn More

          - [Scorecards Documentation](https://github.com/${{ inputs.scorecards-repo }})
          - [View Catalog](https://github.com/${{ inputs.scorecards-repo }}/tree/${{ inputs.scorecards-branch }})

          ---

          ðŸ¤– This PR was automatically created by the Scorecards installation workflow.
          If you close this PR without merging, we'll respect your decision and won't create another one.
          However, scorecards will continue to run daily and results will be available in the Actions tab.
          EOF

          # Create the label if it doesn't exist
          gh label create "scorecards-install" --description "Automated scorecards installation PR" --color "0366d6" 2>/dev/null || true

          # Create the PR
          pr_url=$(gh pr create \
            --title "chore: Add Scorecards quality monitoring" \
            --body-file pr-body.md \
            --label "scorecards-install" \
            --head scorecards-install \
            --base "${GITHUB_REF#refs/heads/}")

          # Extract PR number from URL
          pr_number=$(echo "$pr_url" | grep -oP '/pull/\K\d+')

          echo "pr-number=$pr_number" >> $GITHUB_OUTPUT
          echo "pr-state=OPEN" >> $GITHUB_OUTPUT
          echo "pr-url=$pr_url" >> $GITHUB_OUTPUT

          echo "âœ… Created installation PR #$pr_number"

      - name: Cleanup
        if: always()
        run: |
          rm -rf .scorecards-tmp
          rm -f pr-body.md

  run-scorecards:
    name: Calculate Scorecards
    runs-on: ubuntu-latest
    needs: [check-status, create-installation-pr-placeholder]
    if: |
      always() &&
      needs.check-status.outputs.installed == 'false' &&
      !cancelled()
    outputs:
      score: ${{ steps.final-outputs.outputs.score }}
      rank: ${{ steps.final-outputs.outputs.rank }}
      passed-checks: ${{ steps.final-outputs.outputs.passed-checks }}
      total-checks: ${{ steps.final-outputs.outputs.total-checks }}
      results-file: ${{ steps.final-outputs.outputs.results-file }}
    env:
      # Pass PR info from either existing PR or newly created PR
      PR_NUMBER: ${{ needs.create-installation-pr-placeholder.outputs.pr-number || needs.check-status.outputs.pr-number }}
      PR_STATE: ${{ needs.create-installation-pr-placeholder.outputs.pr-state || needs.check-status.outputs.pr-state }}
      PR_URL: ${{ needs.create-installation-pr-placeholder.outputs.pr-url || format('https://github.com/{0}/pull/{1}', github.repository, needs.check-status.outputs.pr-number) }}
    steps:
      - name: Get current date
        id: date
        run: echo "date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Restore cached results
        id: cache
        uses: actions/cache/restore@v4
        with:
          path: scorecard-results.json
          key: scorecards-results-${{ github.repository }}-${{ steps.date.outputs.date }}

      - name: Extract cached outputs
        if: steps.cache.outputs.cache-hit == 'true'
        id: cached-results
        run: |
          echo "ðŸ“¦ Using cached results from today"
          echo "score=$(jq -r '.score' scorecard-results.json)" >> $GITHUB_OUTPUT
          echo "rank=$(jq -r '.rank' scorecard-results.json)" >> $GITHUB_OUTPUT
          echo "passed-checks=$(jq -r '.passed_checks' scorecard-results.json)" >> $GITHUB_OUTPUT
          echo "total-checks=$(jq -r '.total_checks' scorecard-results.json)" >> $GITHUB_OUTPUT
          echo "results-file=scorecard-results.json" >> $GITHUB_OUTPUT

      - name: Checkout service repository
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4

      - name: Run Scorecards Action
        if: steps.cache.outputs.cache-hit != 'true'
        id: scorecards
        uses: feddericovonwernich/scorecards/action@main
        with:
          github-token: ${{ secrets.scorecards-catalog-token }}
          scorecards-repo: ${{ inputs.scorecards-repo }}
          scorecards-branch: ${{ inputs.scorecards-branch }}

      - name: Set final outputs
        id: final-outputs
        run: |
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "score=${{ steps.cached-results.outputs.score }}" >> $GITHUB_OUTPUT
            echo "rank=${{ steps.cached-results.outputs.rank }}" >> $GITHUB_OUTPUT
            echo "passed-checks=${{ steps.cached-results.outputs.passed-checks }}" >> $GITHUB_OUTPUT
            echo "total-checks=${{ steps.cached-results.outputs.total-checks }}" >> $GITHUB_OUTPUT
            echo "results-file=${{ steps.cached-results.outputs.results-file }}" >> $GITHUB_OUTPUT
          else
            echo "score=${{ steps.scorecards.outputs.score }}" >> $GITHUB_OUTPUT
            echo "rank=${{ steps.scorecards.outputs.rank }}" >> $GITHUB_OUTPUT
            echo "passed-checks=${{ steps.scorecards.outputs.passed-checks }}" >> $GITHUB_OUTPUT
            echo "total-checks=${{ steps.scorecards.outputs.total-checks }}" >> $GITHUB_OUTPUT
            echo "results-file=${{ steps.scorecards.outputs.results-file }}" >> $GITHUB_OUTPUT
          fi

      - name: Display Results
        run: |
          echo "## ðŸŽ¯ Scorecards Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "ðŸ“¦ **Using cached results from today**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Score**: ${{ steps.final-outputs.outputs.score }}/100" >> $GITHUB_STEP_SUMMARY
          echo "**Rank**: ${{ steps.final-outputs.outputs.rank }}" >> $GITHUB_STEP_SUMMARY
          echo "**Checks**: ${{ steps.final-outputs.outputs.passed-checks }}/${{ steps.final-outputs.outputs.total-checks }} passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Results committed to catalog** âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check-status.outputs.installed }}" = "false" ]; then
            echo "> â„¹ï¸  **Note**: Scorecards workflow is not yet installed in this repository." >> $GITHUB_STEP_SUMMARY
            echo "> An installation PR will be created automatically to add the workflow file." >> $GITHUB_STEP_SUMMARY
            echo "> Your scores are already being tracked in the [central catalog](https://github.com/${{ inputs.scorecards-repo }}/tree/${{ inputs.scorecards-branch }})!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Display detailed results if available
          if [ -f "${{ steps.final-outputs.outputs.results-file }}" ]; then
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>ðŸ“Š Detailed Check Results</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat "${{ steps.final-outputs.outputs.results-file }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cache results
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ steps.final-outputs.outputs.results-file }}
          key: scorecards-results-${{ github.repository }}-${{ steps.date.outputs.date }}

      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        with:
          name: scorecards-results
          path: ${{ steps.final-outputs.outputs.results-file }}
          retention-days: 1

  update-installation-pr:
    name: Update Installation PR with Results
    runs-on: ubuntu-latest
    needs: [check-status, create-installation-pr-placeholder, run-scorecards]
    if: |
      needs.check-status.outputs.installed == 'false' &&
      needs.create-installation-pr-placeholder.result == 'success' &&
      needs.run-scorecards.result == 'success'
    steps:
      - name: Checkout service repository
        uses: actions/checkout@v4

      - name: Update Pull Request with Results
        env:
          GH_TOKEN: ${{ secrets.scorecards-workflow-token || secrets.github-token }}
        run: |
          # Determine PR number from either existing or newly created PR
          PR_NUMBER="${{ needs.create-installation-pr-placeholder.outputs.pr-number || needs.check-status.outputs.pr-number }}"

          # Create updated PR body with results
          cat > pr-body.md << 'EOF'
          ## ðŸŽ¯ Scorecards Quality Monitoring

          This PR adds automated quality monitoring using Scorecards.

          ### What's Included

          - **Workflow file**: `.github/workflows/scorecards.yml` - Runs daily to calculate quality scores
          - **Config file**: `.scorecard/config.yml` - Service metadata and configuration

          ### Current Score

          **Score**: ${{ needs.run-scorecards.outputs.score }}/100
          **Rank**: ${{ needs.run-scorecards.outputs.rank }}
          **Checks Passed**: ${{ needs.run-scorecards.outputs.passed-checks }}/${{ needs.run-scorecards.outputs.total-checks }}

          ### What Happens After Merge

          Once merged, scorecards will:
          - âœ… Run daily via cron schedule (configurable)
          - âœ… Post results to the central catalog
          - âœ… Generate quality badges for your README
          - âœ… Track score trends over time

          ### Customize Your Config

          Edit `.scorecard/config.yml` to add:
          - Team name
          - Service description
          - Links to documentation
          - OpenAPI spec location (if applicable)

          ### Learn More

          - [Scorecards Documentation](https://github.com/${{ inputs.scorecards-repo }})
          - [View Catalog](https://github.com/${{ inputs.scorecards-repo }}/tree/${{ inputs.scorecards-branch }})

          ---

          ðŸ¤– This PR was automatically created by the Scorecards installation workflow.
          If you close this PR without merging, we'll respect your decision and won't create another one.
          However, scorecards will continue to run daily and results will be available in the Actions tab.
          EOF

          # Update the PR description
          gh pr edit "$PR_NUMBER" --body-file pr-body.md

          echo "âœ… Updated installation PR #$PR_NUMBER with scorecard results"

      - name: Cleanup
        if: always()
        run: |
          rm -f pr-body.md
