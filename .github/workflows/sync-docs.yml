name: Sync Catalog UI to Catalog Branch

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
  workflow_dispatch:

jobs:
  sync-catalog:
    runs-on: ubuntu-latest
    name: Sync Catalog UI
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main
          path: main-repo

      - name: Checkout catalog branch
        uses: actions/checkout@v3
        with:
          ref: catalog
          path: catalog-repo
          token: ${{ secrets.SCORECARDS_CATALOG_TOKEN || secrets.SCORECARDS_WORKFLOW_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: main-repo/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: main-repo

      - name: Build catalog UI
        run: npm run build
        working-directory: main-repo

      - name: Sync catalog UI files
        run: |
          # Sync built files from dist/ to catalog branch docs/
          # Vite compiles TypeScript to JavaScript in docs/dist/
          rsync -av --delete main-repo/docs/dist/ catalog-repo/docs/

          # Copy standalone HTML files not included in Vite build
          cp main-repo/docs/api-explorer.html catalog-repo/docs/

      - name: Commit and push to catalog
        run: |
          cd catalog-repo

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/

          if git diff --staged --quiet; then
            echo "No changes to catalog UI, skipping commit"
          else
            git commit -m "Sync catalog UI from main branch

            Auto-synced catalog UI changes from main branch.

            Co-Authored-By: GitHub Actions <github-actions[bot]@users.noreply.github.com>"

            # Push with retry logic to handle concurrent pushes
            max_retries=5
            retry_count=0
            push_success=false

            while [ "$retry_count" -lt "$max_retries" ]; do
              if git push origin catalog; then
                echo "✓ Catalog UI synced to catalog branch"
                push_success=true
                break
              else
                retry_count=$((retry_count + 1))

                if [ "$retry_count" -lt "$max_retries" ]; then
                  echo "⚠ Push failed (attempt $retry_count/$max_retries), retrying..."

                  # Fetch and rebase
                  git fetch origin catalog

                  if git rebase origin/catalog; then
                    echo "Rebase successful, retrying push..."
                    # Exponential backoff with jitter
                    backoff=$((5 + retry_count * 3 + RANDOM % 5))
                    echo "Waiting ${backoff}s before retry..."
                    sleep "$backoff"
                  else
                    echo "✗ Rebase failed, aborting"
                    git rebase --abort
                    exit 1
                  fi
                fi
              fi
            done

            if [ "$push_success" = "false" ]; then
              echo "✗ Failed to push after $max_retries attempts"
              exit 1
            fi
          fi
