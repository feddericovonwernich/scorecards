<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Explorer - Scorecards</title>
    <script>
        // Apply theme immediately to prevent flash
        (function() {
            const THEME_KEY = 'theme';
            const savedTheme = localStorage.getItem(THEME_KEY);
            const osPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (osPrefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    <link rel="stylesheet" type="text/css" href="css/base/variables.css">
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5.11.0/swagger-ui.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-primary);
            background: var(--color-bg);
            color: var(--color-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-5);
            margin-bottom: var(--space-5);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title {
            flex: 1;
            min-width: 200px;
        }

        .header-title h1 {
            font-size: var(--text-xl);
            color: var(--color-text);
            margin-bottom: var(--space-1);
            font-weight: var(--font-weight-semibold);
        }

        .header-title p {
            color: var(--color-text-muted);
            font-size: var(--text-sm);
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .theme-toggle-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-in-out-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
        }

        .theme-toggle-btn:hover {
            background: var(--color-surface-secondary);
            border-color: var(--color-border-strong);
            color: var(--color-text);
        }

        .back-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--color-accent);
            color: white;
            text-decoration: none;
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: var(--font-weight-medium);
            font-family: var(--font-family-primary);
            display: inline-block;
            transition: all var(--duration-fast) var(--ease-in-out-smooth);
        }

        .back-btn:hover {
            background: var(--color-accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .loading {
            text-align: center;
            padding: var(--space-12) var(--space-5);
            color: var(--color-text-muted);
        }

        .error {
            max-width: 600px;
            margin: var(--space-12) auto;
            padding: var(--space-6);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .error h2 {
            color: var(--color-error);
            margin-bottom: var(--space-4);
        }

        .error p {
            color: var(--color-text-muted);
            line-height: 1.6;
        }

        #swagger-ui {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Customize Swagger UI to match our theme */
        .swagger-ui .topbar {
            display: none;
        }

        /* Swagger UI Dark Mode Overrides */
        [data-theme="dark"] .swagger-ui {
            background: var(--color-bg);
        }

        [data-theme="dark"] .swagger-ui .wrapper {
            background: var(--color-bg);
        }

        /* Info section */
        [data-theme="dark"] .swagger-ui .info .title,
        [data-theme="dark"] .swagger-ui .info .title small {
            color: var(--color-text);
        }

        [data-theme="dark"] .swagger-ui .info .description,
        [data-theme="dark"] .swagger-ui .info .description p,
        [data-theme="dark"] .swagger-ui .info li,
        [data-theme="dark"] .swagger-ui .info table,
        [data-theme="dark"] .swagger-ui .info table thead tr th,
        [data-theme="dark"] .swagger-ui .info table tbody tr td {
            color: var(--color-text-muted);
        }

        /* Links */
        [data-theme="dark"] .swagger-ui a.link,
        [data-theme="dark"] .swagger-ui .info a {
            color: var(--color-link);
        }

        /* Scheme container (server selector) */
        [data-theme="dark"] .swagger-ui .scheme-container {
            background: transparent;
            box-shadow: none;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
        }

        [data-theme="dark"] .swagger-ui .scheme-container .schemes > label {
            color: var(--color-text);
        }

        /* Operation blocks (GET, POST, etc.) */
        [data-theme="dark"] .swagger-ui .opblock-tag {
            color: var(--color-text);
            border-bottom: 1px solid var(--color-border);
        }

        [data-theme="dark"] .swagger-ui .opblock-tag:hover {
            background: var(--color-surface);
        }

        [data-theme="dark"] .swagger-ui .opblock {
            border-color: var(--color-border);
            background: var(--color-surface);
        }

        [data-theme="dark"] .swagger-ui .opblock .opblock-summary-description {
            color: var(--color-text-muted);
        }

        [data-theme="dark"] .swagger-ui .opblock .opblock-section-header {
            background: var(--color-surface-secondary);
            border-bottom: 1px solid var(--color-border);
        }

        [data-theme="dark"] .swagger-ui .opblock .opblock-section-header h4 {
            color: var(--color-text);
        }

        /* Parameters and responses */
        [data-theme="dark"] .swagger-ui .parameters-col_description,
        [data-theme="dark"] .swagger-ui .response-col_description,
        [data-theme="dark"] .swagger-ui table thead tr th,
        [data-theme="dark"] .swagger-ui table thead tr td,
        [data-theme="dark"] .swagger-ui .parameter__name,
        [data-theme="dark"] .swagger-ui .parameter__type,
        [data-theme="dark"] .swagger-ui .parameter__extension,
        [data-theme="dark"] .swagger-ui .parameter__in {
            color: var(--color-text-muted);
        }

        [data-theme="dark"] .swagger-ui .parameters-col_name {
            color: var(--color-text);
        }

        [data-theme="dark"] .swagger-ui .opblock-body pre.microlight {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        /* Models/Schemas section */
        [data-theme="dark"] .swagger-ui section.models {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
        }

        [data-theme="dark"] .swagger-ui section.models h4,
        [data-theme="dark"] .swagger-ui section.models.is-open h4 {
            color: var(--color-text);
            border-bottom: 1px solid var(--color-border);
        }

        [data-theme="dark"] .swagger-ui .model-title {
            color: var(--color-text);
        }

        [data-theme="dark"] .swagger-ui .model {
            color: var(--color-text-muted);
        }

        [data-theme="dark"] .swagger-ui .model-box {
            background: var(--color-bg);
        }

        /* Buttons */
        [data-theme="dark"] .swagger-ui .btn {
            border-color: var(--color-border);
            color: var(--color-text);
        }

        [data-theme="dark"] .swagger-ui .btn.authorize {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }

        [data-theme="dark"] .swagger-ui .btn.authorize svg {
            fill: #064e3b;
        }

        [data-theme="dark"] .swagger-ui .btn.cancel {
            border-color: var(--color-error);
            color: var(--color-error);
        }

        /* Form inputs */
        [data-theme="dark"] .swagger-ui input[type=text],
        [data-theme="dark"] .swagger-ui input[type=password],
        [data-theme="dark"] .swagger-ui input[type=email],
        [data-theme="dark"] .swagger-ui textarea,
        [data-theme="dark"] .swagger-ui select {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        /* Dialog/Modal */
        [data-theme="dark"] .swagger-ui .dialog-ux .modal-ux {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
        }

        [data-theme="dark"] .swagger-ui .dialog-ux .modal-ux-header h3 {
            color: var(--color-text);
        }

        [data-theme="dark"] .swagger-ui .dialog-ux .modal-ux-content {
            color: var(--color-text-muted);
        }

        /* Response codes */
        [data-theme="dark"] .swagger-ui .responses-inner {
            background: var(--color-surface);
        }

        [data-theme="dark"] .swagger-ui .response .response-col_status {
            color: var(--color-text);
        }

        [data-theme="dark"] .swagger-ui .response .response-col_description {
            color: var(--color-text-muted);
        }

        [data-theme="dark"] .swagger-ui .response .response-col_description__inner p {
            color: var(--color-text-muted);
        }

        /* Tab panels */
        [data-theme="dark"] .swagger-ui .tab li {
            color: var(--color-text-muted);
        }

        [data-theme="dark"] .swagger-ui .tab li.active {
            color: var(--color-text);
        }

        /* Copy to clipboard button */
        [data-theme="dark"] .swagger-ui .copy-to-clipboard {
            background: var(--color-surface);
        }

        /* Try it out button */
        [data-theme="dark"] .swagger-ui .try-out__btn {
            border-color: var(--color-border);
            color: var(--color-text);
        }

        [data-theme="dark"] .swagger-ui .try-out__btn:hover {
            background: var(--color-surface-secondary);
        }

        /* Execute button */
        [data-theme="dark"] .swagger-ui .execute {
            background: var(--color-accent);
            border-color: var(--color-accent);
        }

        [data-theme="dark"] .swagger-ui .execute:hover {
            background: var(--color-accent-hover);
        }

        /* Markdown content */
        [data-theme="dark"] .swagger-ui .markdown p,
        [data-theme="dark"] .swagger-ui .markdown li,
        [data-theme="dark"] .swagger-ui .renderedMarkdown p,
        [data-theme="dark"] .swagger-ui .renderedMarkdown li {
            color: var(--color-text-muted);
        }

        /* Expand/collapse arrows */
        [data-theme="dark"] .swagger-ui .expand-operation svg,
        [data-theme="dark"] .swagger-ui .expand-methods svg {
            fill: var(--color-text-muted);
        }

        /* Loading indicator */
        [data-theme="dark"] .swagger-ui .loading-container .loading:after {
            border-color: var(--color-accent) transparent var(--color-accent) transparent;
        }

        /* Servers dropdown in dark mode - enhanced styling */
        [data-theme="dark"] .swagger-ui .servers > label select {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text);
            padding: 8px 32px 8px 12px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12' fill='%2371717A'%3E%3Cpath d='M2.5 4.5L6 8L9.5 4.5' stroke='%2371717A' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            min-width: 200px;
            transition: border-color var(--duration-fast) var(--ease-in-out-smooth),
                        box-shadow var(--duration-fast) var(--ease-in-out-smooth);
        }

        [data-theme="dark"] .swagger-ui .servers > label select:hover {
            border-color: var(--color-border-strong);
        }

        [data-theme="dark"] .swagger-ui .servers > label select:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px var(--color-accent-light);
        }

        [data-theme="dark"] .swagger-ui .servers > label select option {
            background: var(--color-surface);
            color: var(--color-text);
            padding: 8px 12px;
        }

        [data-theme="dark"] .swagger-ui .servers > label select option:hover,
        [data-theme="dark"] .swagger-ui .servers > label select option:focus {
            background: var(--color-surface-secondary);
        }

        /* Model toggle arrow */
        [data-theme="dark"] .swagger-ui .model-toggle:after {
            border-color: var(--color-text-muted);
        }

        /* Authorization lock icon */
        [data-theme="dark"] .swagger-ui .authorization__btn svg {
            fill: var(--color-text-muted);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <h1 id="api-title">API Explorer</h1>
                <p id="api-subtitle">Loading API specification...</p>
            </div>
            <div class="header-controls">
                <button id="theme-toggle-btn" class="theme-toggle-btn" title="Toggle night mode" aria-label="Toggle night mode">
                    <svg id="theme-icon-sun" width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 12a4 4 0 1 1 0-8 4 4 0 0 1 0 8Zm0-1.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Zm5.657-8.157a.75.75 0 0 1 0 1.061l-1.061 1.06a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734l1.06-1.06a.75.75 0 0 1 1.06 0Zm-9.193 9.193a.75.75 0 0 1 0 1.06l-1.06 1.061a.75.75 0 1 1-1.061-1.06l1.06-1.061a.75.75 0 0 1 1.061 0ZM8 0a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0V.75A.75.75 0 0 1 8 0ZM3 8a.75.75 0 0 1-.75.75H.75a.75.75 0 0 1 0-1.5h1.5A.75.75 0 0 1 3 8Zm13 0a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1 0-1.5h1.5A.75.75 0 0 1 16 8Zm-8 5a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 8 13Zm3.536-1.464a.75.75 0 0 1 1.06 0l1.061 1.06a.75.75 0 0 1-1.06 1.061l-1.061-1.06a.75.75 0 0 1 0-1.061ZM2.343 2.343a.75.75 0 0 1 1.061 0l1.06 1.061a.751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018l-1.06-1.06a.75.75 0 0 1 0-1.06Z"></path>
                    </svg>
                    <svg id="theme-icon-moon" width="20" height="20" viewBox="0 0 16 16" fill="currentColor" style="display: none;">
                        <path d="M9.598 1.591a.749.749 0 0 1 .785-.175 7.001 7.001 0 1 1-8.967 8.967.75.75 0 0 1 .961-.96 5.5 5.5 0 0 0 7.046-7.046.75.75 0 0 1 .175-.786Zm1.616 1.945a7 7 0 0 1-7.678 7.678 5.499 5.499 0 1 0 7.678-7.678Z"></path>
                    </svg>
                </button>
                <a href="./" class="back-btn">‚Üê Back to Catalog</a>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        <div>Loading API specification...</div>
    </div>

    <div id="error" class="error" style="display:none;">
        <h2>Failed to Load API</h2>
        <p id="error-message"></p>
    </div>

    <div id="swagger-ui"></div>

    <script src="https://unpkg.com/swagger-ui-dist@5.11.0/swagger-ui-bundle.js"></script>
    <script src="https://unpkg.com/swagger-ui-dist@5.11.0/swagger-ui-standalone-preset.js"></script>
    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const org = urlParams.get('org');
        const repo = urlParams.get('repo');

        // Configuration
        const REPO_OWNER = urlParams.get('catalog_owner') || window.location.hostname.split('.')[0] || 'your-org';
        const REPO_NAME = 'scorecards';
        const BRANCH = 'catalog';
        const RAW_BASE_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}`;

        let serviceData = null;
        let swaggerUi = null;

        // Main initialization
        async function init() {
            if (!org || !repo) {
                showError('Missing parameters. Please specify org and repo in the URL.');
                return;
            }

            try {
                // Load service results to get OpenAPI config
                const resultsUrl = `${RAW_BASE_URL}/results/${org}/${repo}/results.json?t=${Date.now()}`;
                const response = await fetch(resultsUrl, { cache: 'no-cache' });

                if (!response.ok) {
                    throw new Error(`Service not found or results not available (${response.status})`);
                }

                serviceData = await response.json();

                // Update header
                document.getElementById('api-title').textContent = serviceData.service.name || `${org}/${repo}`;
                document.getElementById('api-subtitle').textContent = `${org}/${repo} - OpenAPI Specification`;

                // Check if service has OpenAPI config
                if (!serviceData.service.openapi) {
                    throw new Error('This service does not have OpenAPI configuration');
                }

                // Find the OpenAPI spec file path and branch
                const specPath = serviceData.service.openapi.spec_file || 'openapi.yaml';
                const configuredBranch = serviceData.service.openapi.branch;

                // Load the OpenAPI spec from the service repository
                // Use configured branch if available, otherwise try common branch names
                const branches = configuredBranch ? [configuredBranch] : ['main', 'master'];
                let specUrl = null;
                let lastError = null;

                for (const branch of branches) {
                    const url = `https://raw.githubusercontent.com/${org}/${repo}/${branch}/${specPath}`;
                    try {
                        const response = await fetch(url, { method: 'HEAD' });
                        if (response.ok) {
                            specUrl = url;
                            break;
                        }
                    } catch (e) {
                        lastError = e;
                    }
                }

                if (!specUrl) {
                    const branchInfo = configuredBranch
                        ? `configured branch: ${configuredBranch}`
                        : `tried branches: ${branches.join(', ')}`;
                    throw new Error(`OpenAPI specification file not found at ${specPath} (${branchInfo})`);
                }

                // Initialize Swagger UI
                await loadSwaggerUI(specUrl);

                // Hide loading, show UI
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error loading API:', error);
                showError(error.message);
            }
        }

        // Load Swagger UI with the OpenAPI spec
        async function loadSwaggerUI(specUrl) {
            try {
                // Fetch the spec first to validate it exists
                const specResponse = await fetch(specUrl);
                if (!specResponse.ok) {
                    throw new Error(`OpenAPI specification file not found at ${specUrl}`);
                }

                const specContent = await specResponse.text();

                // Parse spec to get the format (JSON or YAML)
                let spec;
                try {
                    spec = JSON.parse(specContent);
                } catch {
                    // If not JSON, assume YAML - Swagger UI can handle it
                    spec = specContent;
                }

                // Initialize Swagger UI
                swaggerUi = SwaggerUIBundle({
                    spec: typeof spec === 'string' ? undefined : spec,
                    url: typeof spec === 'string' ? specUrl : undefined,
                    dom_id: '#swagger-ui',
                    deepLinking: true,
                    presets: [
                        SwaggerUIBundle.presets.apis,
                        SwaggerUIStandalonePreset
                    ],
                    plugins: [
                        SwaggerUIBundle.plugins.DownloadUrl
                    ],
                    layout: "StandaloneLayout"
                });

            } catch (error) {
                throw new Error(`Failed to load OpenAPI spec: ${error.message}`);
            }
        }

        // Show error message
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        // Theme management
        const THEME_KEY = 'theme';
        const THEMES = { LIGHT: 'light', DARK: 'dark' };

        function getOSPreference() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                return THEMES.DARK;
            }
            return THEMES.LIGHT;
        }

        function getSavedTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            if (saved === THEMES.DARK || saved === THEMES.LIGHT) {
                return saved;
            }
            return getOSPreference();
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon(theme);
        }

        function updateThemeIcon(theme) {
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');
            if (theme === THEMES.DARK) {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            } else {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            }
        }

        function getCurrentTheme() {
            return document.documentElement.getAttribute('data-theme') || THEMES.LIGHT;
        }

        function toggleTheme() {
            const current = getCurrentTheme();
            const newTheme = current === THEMES.DARK ? THEMES.LIGHT : THEMES.DARK;
            applyTheme(newTheme);
            localStorage.setItem(THEME_KEY, newTheme);
            return newTheme;
        }

        function initTheme() {
            const theme = getSavedTheme();
            applyTheme(theme);

            // Listen for OS preference changes
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (!saved) {
                        const newTheme = e.matches ? THEMES.DARK : THEMES.LIGHT;
                        applyTheme(newTheme);
                    }
                });
            }

            // Attach toggle button event listener
            const toggleBtn = document.getElementById('theme-toggle-btn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleTheme);
            }
        }

        // Initialize theme early
        initTheme();

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
