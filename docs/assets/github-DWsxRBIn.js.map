{"version":3,"file":"github-DWsxRBIn.js","sources":["../../src/api/github.ts"],"sourcesContent":["/**\n * GitHub API Client\n * Functions for interacting with GitHub's REST API\n */\n\nimport { getToken } from '../services/auth.js';\nimport { getRepoOwner, getRepoName } from './registry.js';\nimport { API_CONFIG } from '../config/constants.js';\nimport type { WorkflowRun, RateLimitInfo, GitHubUser } from '../types/index.js';\n\ninterface WorkflowRunsResponse {\n  workflow_runs: WorkflowRun[];\n  total_count: number;\n}\n\ninterface RateLimitResponse {\n  rate: {\n    remaining: number;\n    limit: number;\n    reset: number;\n  };\n}\n\nexport interface FetchWorkflowRunsOptions {\n  per_page?: number;\n}\n\n/**\n * Make a GitHub API request\n */\nexport async function githubApiRequest(\n  endpoint: string,\n  options: RequestInit = {}\n): Promise<Response> {\n  const token = getToken();\n\n  const headers: Record<string, string> = {\n    Accept: API_CONFIG.ACCEPT_HEADER,\n    ...(options.headers as Record<string, string>),\n  };\n\n  if (token) {\n    headers['Authorization'] = `token ${token}`;\n  }\n\n  const response = await fetch(`${API_CONFIG.GITHUB_BASE_URL}${endpoint}`, {\n    ...options,\n    headers,\n  });\n\n  return response;\n}\n\n/**\n * Check GitHub API rate limit\n */\nexport async function checkRateLimit(): Promise<RateLimitInfo> {\n  try {\n    const response = await githubApiRequest('/rate_limit');\n    const data: RateLimitResponse = await response.json();\n\n    return {\n      remaining: data.rate.remaining,\n      limit: data.rate.limit,\n      reset: new Date(data.rate.reset * 1000),\n    };\n  } catch (error) {\n    console.error('Error checking rate limit:', error);\n    return {\n      remaining: null,\n      limit: null,\n      reset: null,\n      error: error instanceof Error ? error.message : String(error),\n    };\n  }\n}\n\n/**\n * Fetch workflow runs for a repository\n */\nexport async function fetchWorkflowRuns(\n  org: string,\n  repo: string,\n  options: FetchWorkflowRunsOptions = {}\n): Promise<WorkflowRun[]> {\n  const perPage = options.per_page || API_CONFIG.PER_PAGE;\n  const endpoint = `/repos/${org}/${repo}/actions/runs?per_page=${perPage}&_t=${Date.now()}`;\n\n  try {\n    const response = await githubApiRequest(endpoint, {\n      cache: 'no-cache',\n    });\n\n    if (!response.ok) {\n      throw new Error(`Failed to fetch workflow runs: ${response.status}`);\n    }\n\n    const data: WorkflowRunsResponse = await response.json();\n\n    // Add org/repo metadata to each run\n    return data.workflow_runs.map((run) => ({\n      ...run,\n      org,\n      repo,\n    }));\n  } catch (error) {\n    console.error(`Error fetching workflow runs for ${org}/${repo}:`, error);\n    throw error;\n  }\n}\n\n/**\n * Trigger a workflow dispatch event\n */\nexport async function triggerWorkflowDispatch(\n  org: string,\n  repo: string,\n  workflow: string,\n  inputs: Record<string, string> = {},\n  ref = 'main'\n): Promise<boolean> {\n  const token = getToken();\n\n  if (!token) {\n    throw new Error('GitHub token required to trigger workflows');\n  }\n\n  try {\n    const response = await fetch(\n      `https://api.github.com/repos/${org}/${repo}/actions/workflows/${workflow}/dispatches`,\n      {\n        method: 'POST',\n        headers: {\n          Accept: 'application/vnd.github+json',\n          Authorization: `Bearer ${token}`,\n          'X-GitHub-Api-Version': '2022-11-28',\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          ref,\n          inputs,\n        }),\n      }\n    );\n\n    // GitHub returns 204 No Content on success\n    return response.status === 204;\n  } catch (error) {\n    console.error('Error triggering workflow:', error);\n    throw error;\n  }\n}\n\n/**\n * Trigger scorecard workflow for a service\n */\nexport async function triggerScorecardWorkflow(\n  org: string,\n  repo: string\n): Promise<boolean> {\n  const scorecardOrg = getRepoOwner();\n  const scorecardRepo = getRepoName();\n\n  return triggerWorkflowDispatch(\n    scorecardOrg,\n    scorecardRepo,\n    'trigger-service-workflow.yml',\n    { org, repo }\n  );\n}\n\nexport interface ServiceIdentifier {\n  org: string;\n  repo: string;\n}\n\n/**\n * Trigger scorecards for multiple services (bulk operation)\n */\nexport async function triggerBulkScorecardWorkflows(\n  services: ServiceIdentifier[]\n): Promise<boolean> {\n  const scorecardOrg = getRepoOwner();\n  const scorecardRepo = getRepoName();\n\n  const servicesArray = services.map((s) => ({ org: s.org, repo: s.repo }));\n\n  return triggerWorkflowDispatch(\n    scorecardOrg,\n    scorecardRepo,\n    'trigger-service-workflow.yml',\n    { services: JSON.stringify(servicesArray) }\n  );\n}\n\n/**\n * Create installation PR for a service\n */\nexport async function createInstallationPR(\n  org: string,\n  repo: string\n): Promise<boolean> {\n  const scorecardOrg = getRepoOwner();\n  const scorecardRepo = getRepoName();\n\n  return triggerWorkflowDispatch(\n    scorecardOrg,\n    scorecardRepo,\n    'create-installation-pr.yml',\n    { org, repo }\n  );\n}\n\n/**\n * Get user information from GitHub\n */\nexport async function getUserInfo(): Promise<GitHubUser> {\n  const response = await githubApiRequest('/user');\n\n  if (!response.ok) {\n    throw new Error('Failed to fetch user info');\n  }\n\n  return response.json();\n}\n"],"names":["githubApiRequest","endpoint","options","token","getToken","headers","API_CONFIG","fetchWorkflowRuns","org","repo","perPage","response","run","error","triggerWorkflowDispatch","workflow","inputs","ref","triggerScorecardWorkflow","scorecardOrg","getRepoOwner","scorecardRepo","getRepoName"],"mappings":"iGA8BA,eAAsBA,EACpBC,EACAC,EAAuB,GACJ,CACnB,MAAMC,EAAQC,EAAA,EAERC,EAAkC,CACtC,OAAQC,EAAW,cACnB,GAAIJ,EAAQ,OAAA,EAGd,OAAIC,IACFE,EAAQ,cAAmB,SAASF,CAAK,IAG1B,MAAM,MAAM,GAAGG,EAAW,eAAe,GAAGL,CAAQ,GAAI,CACvE,GAAGC,EACH,QAAAG,CAAA,CACD,CAGH,CA6BA,eAAsBE,EACpBC,EACAC,EACAP,EAAoC,CAAA,EACZ,CACxB,MAAMQ,EAAUR,EAAQ,UAAYI,EAAW,SACzCL,EAAW,UAAUO,CAAG,IAAIC,CAAI,0BAA0BC,CAAO,OAAO,KAAK,IAAA,CAAK,GAExF,GAAI,CACF,MAAMC,EAAW,MAAMX,EAAiBC,EAAU,CAChD,MAAO,UAAA,CACR,EAED,GAAI,CAACU,EAAS,GACZ,MAAM,IAAI,MAAM,kCAAkCA,EAAS,MAAM,EAAE,EAMrE,OAHmC,MAAMA,EAAS,KAAA,GAGtC,cAAc,IAAKC,IAAS,CACtC,GAAGA,EACH,IAAAJ,EACA,KAAAC,CAAA,EACA,CACJ,OAASI,EAAO,CACd,cAAQ,MAAM,oCAAoCL,CAAG,IAAIC,CAAI,IAAKI,CAAK,EACjEA,CACR,CACF,CAKA,eAAsBC,EACpBN,EACAC,EACAM,EACAC,EAAiC,CAAA,EACjCC,EAAM,OACY,CAClB,MAAMd,EAAQC,EAAA,EAEd,GAAI,CAACD,EACH,MAAM,IAAI,MAAM,4CAA4C,EAG9D,GAAI,CAmBF,OAlBiB,MAAM,MACrB,gCAAgCK,CAAG,IAAIC,CAAI,sBAAsBM,CAAQ,cACzE,CACE,OAAQ,OACR,QAAS,CACP,OAAQ,8BACR,cAAe,UAAUZ,CAAK,GAC9B,uBAAwB,aACxB,eAAgB,kBAAA,EAElB,KAAM,KAAK,UAAU,CACnB,IAAAc,EACA,OAAAD,CAAA,CACD,CAAA,CACH,GAIc,SAAW,GAC7B,OAASH,EAAO,CACd,cAAQ,MAAM,6BAA8BA,CAAK,EAC3CA,CACR,CACF,CAKA,eAAsBK,EACpBV,EACAC,EACkB,CAClB,MAAMU,EAAeC,EAAA,EACfC,EAAgBC,EAAA,EAEtB,OAAOR,EACLK,EACAE,EACA,+BACA,CAAE,IAAAb,EAAK,KAAAC,CAAA,CAAK,CAEhB"}